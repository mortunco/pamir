<!DOCTYPE html>
<html lang="en">
<head>
    <title>Analysis Report Generated by Pamir2.0</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
    <script src="http://igv.org/web/snapshot/dist/igv.min.js"></script>
    <script src="./data.js"></script>
    <script src="./summary.js"></script>


    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            padding-top: 70px;
    </style>
</head>

<body class="container">

<div class="row">
<div class="input-group input-group-lg col-md-12">
  <input type="text" class="form-control" aria-label="Remote-Path" placeholder="Remote Path for data on server"  aria-describedby="inputGroup-sizing-sm" id="remote-path" value="">
</div>
</div>

<div class="row">
    <div class="col-md-8">
        <h4><span id="cohort"></span> Cohort Summary </h4>
        <table id="summary_table" data-pagination="true" data-striped="true" data-show-refresh="true"
               data-page-size="15" data-search="true ">
            <thead>
            <tr>
                <th data-field="e" data-width="30%" data-sortable="true" data-formatter="eventFiller">Event</th>
                <th data-field="c" data-sortable="true">Count</th>
                <th data-field="l" data-sortable="true">Insertion Length</th>
                <th data-field="c" data-sortable="true" data-formatter="percFormatter">Percentage</th>
                <th data-field="r" data-sortable="true" >Percentage</th>
            </tr>
            </thead>
        </table>
    </div>
    <div class="col-md-4" style="padding-top:70px;">
        <canvas id="dist"></canvas>
        <canvas id="ins-length-dist"></canvas>
    </div>
</div>

<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalCenter">
    Click on me to see type of Repeats
</button>

<!-- Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalCenterTitle">Repeat Types</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="repeat-id"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <table id="table_mut" data-pagination="true" data-striped="true" data-show-refresh="true" data-page-size="15"
               data-search="true " data-query-params="queryParams" data-show-columns="true">
            <thead>
            <tr>
                <th data-field="id" data-sortable="true">Event</th>
                <th data-field="s" data-sortable="true">SampleId</th>
                <th data-field="g" data-sortable="true">Genotype</th>
                <th data-field="q" data-sortable="true">Qual</th>
                <th data-field="c" data-sortable="true">ClusterId</th>
                <th data-field="gt" data-sortable="true">Right Flank</th>
                <th data-field="gt" data-sortable="true">Left Flank</th>
                <th data-field="gr" data-sortable="true">Reference</th>
                <th data-field="glr" data-sortable="true">GLRatio</th>
		<th data-field="grr" data-sortable="true">GRRatio</th>
                <th data-field="x" data-formatter="actionFormatter">Actions</th>

            </tr>
            </thead>
        </table>
    </div>
</div>
</body>

<script type="text/javascript">

    mut_data = mut_data[cohort_request];

    var n = Array();
    var mut_table = $("#table_mut");
    mut_table.bootstrapTable({data: n});

    $("#cohort").html(cohort_request);

    function eventFiller(value, row, id) {
        // console.log(value);
        var name = value.substr(0, value.lastIndexOf("-"));
        return ("<a href=\"javascript:my_filter('" + value + "')\"  data-val=\"" + value + "\">" + name + "</a>");
    }

    function percFormatter(value, row, id) {

        return ('<progress value="' + value + '" max="' + cohort_size + '"></progress>&nbsp;<span>' + (value / cohort_size) * 100  + '</span>');

    }

    function my_filter(value) {
        var n = Array();
        for (ind in mut_data["individuals"]) {
            for (mut in mut_data["individuals"][ind]["events"]) {
                if (mut_data["individuals"][ind]["events"][mut]["id"] == value) {
                    n.push(mut_data["individuals"][ind]["events"][mut]);
                }
            }
        }
        var mut_table = $("#table_mut");
        mut_table.bootstrapTable({data: n});
        mut_table.bootstrapTable("load", n);
    }

    var full = location.pathname;
    var path = full.substr(0, full.lastIndexOf("/"));

    function actionFormatter(value, row, id) {
	pp = $("#remote-path").val();
	if (pp!=="")
		path = pp;
        return '<a target="_blank" href="http://localhost:60151/load?file=' + path

            + '/ind/' + row.s + '/events.bed,' + path +
            '/events.repeat.bed,' + path +
            '/ind/' + row.s + '/events.bam&genome=' + path + '/events.fa&locus=' +

            row.id + '"><i class="fa fa-area-chart" aria-hidden="true"></i></a>';
    }

    var histo = Array();
    var label = Array();
    for (i = 0; i < cohort_size; i++) {
        histo.push(0);
        label.push(i + 1);
    }

    for (t in table_summary_file) {

        count = table_summary_file[t]["c"];

        //console.log('=>'+count);
        histo[count - 1]++;
    }
    var ctx = document.getElementById('ins-length-dist');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: length_labels,
            datasets: [{
                label: 'Distribution of Insertion Length',
                data: total_counts,
                fill: false,
                borderWidth: 1,
                borderColor: "rgb(0,0,255)",
                backgroundColor: 'rgb(0,0,255)'
            }, {
                label: 'Distribution of Unique Insert Lengths',
                data: unique_counts,
                fill: false,
                borderWidth: 1,
                borderColor: "rgb(255,0,255)",
                backgroundColor: "rgb(255,0,255)"
            }]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            }
        }
    });


    var ctx2 = document.getElementById('dist');
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: label,
            datasets: [{
                label: 'Number of events shared between individuals',
                data: histo,
                borderWidth: 1,
                backgroundColor: 'rgba(255, 0, 0, 1)'
            }]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            }
        }
    });

    var summary_table = $("#summary_table");
    var mydata = Array();
    for (mut in table_summary_file) {
        mydata.push(table_summary_file[mut]);
    }
    summary_table.bootstrapTable({data: mydata});

    document.getElementById('repeat-id').innerHTML = repeat_types;

</script>
</html>

